generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis]
}

// ─── Enums ───────────────────────────────────────────────────────────

enum OrganizationType {
  PF
  PJ
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  AGRONOMIST
  FINANCIAL
  OPERATOR
  COWBOY
  CONSULTANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum FarmStatus {
  ACTIVE
  INACTIVE
}

enum ProducerType {
  PF
  PJ
  SOCIEDADE_EM_COMUM
}

enum ProducerStatus {
  ACTIVE
  INACTIVE
}

enum ProducerFarmBondType {
  PROPRIETARIO
  ARRENDATARIO
  COMODATARIO
  PARCEIRO
  MEEIRO
  USUFRUTUARIO
  CONDOMINO
}

enum TaxRegime {
  REAL
  PRESUMIDO
  SIMPLES
  ISENTO
}

enum IeSituation {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum IeCategory {
  PRIMEIRO_ESTABELECIMENTO
  DEMAIS
  UNICO
}

// ─── Core Models ─────────────────────────────────────────────────────

model Organization {
  id        String           @id @default(uuid())
  name      String
  type      OrganizationType
  document  String           @unique
  plan      String           @default("basic")
  status    OrgStatus        @default(ACTIVE)
  maxUsers  Int              @default(10)
  maxFarms  Int              @default(5)
  allowMultipleSessions Boolean @default(true)
  allowSocialLogin     Boolean @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  users       User[]
  farms       Farm[]
  customRoles CustomRole[]
  producers   Producer[]

  @@map("organizations")
}

model User {
  id             String     @id @default(uuid())
  email          String     @unique
  name           String
  passwordHash   String?
  phone          String?
  googleId       String?    @unique
  role           UserRole   @default(OPERATOR)
  status         UserStatus @default(ACTIVE)
  lastLoginAt    DateTime?
  organizationId String
  customRoleId   String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id])
  customRole   CustomRole?      @relation(fields: [customRoleId], references: [id], onDelete: SetNull)
  farmAccess   UserFarmAccess[]

  @@map("users")
}

model Farm {
  id                   String                                @id @default(uuid())
  name                 String
  nickname             String?
  address              String?
  city                 String?
  state                String
  zipCode              String?
  totalAreaHa          Decimal                               @db.Decimal(12, 4)
  cib                  String?
  incraCode            String?
  carCode              String?
  ccirCode             String?
  landClassification   String?
  productive           Boolean?
  fiscalModuleHa       Decimal?                              @db.Decimal(12, 4)
  fiscalModulesCount   Decimal?                              @db.Decimal(12, 4)
  minPartitionFraction Decimal?                              @db.Decimal(12, 4)
  appAreaHa            Decimal?                              @db.Decimal(12, 4)
  legalReserveHa       Decimal?                              @db.Decimal(12, 4)
  taxableAreaHa        Decimal?                              @db.Decimal(12, 4)
  usableAreaHa         Decimal?                              @db.Decimal(12, 4)
  utilizationDegree    Decimal?                              @db.Decimal(5, 2)
  status               FarmStatus                            @default(ACTIVE)
  organizationId       String
  boundaryAreaHa       Decimal?                              @db.Decimal(12, 4)
  location             Unsupported("geometry(Point, 4326)")?
  boundary             Unsupported("geometry(Polygon, 4326)")?
  createdAt            DateTime                              @default(now())
  updatedAt            DateTime                              @updatedAt

  organization            Organization              @relation(fields: [organizationId], references: [id])
  userAccess              UserFarmAccess[]
  registrations           FarmRegistration[]
  documents               FarmDocument[]
  producerFarmLinks       ProducerFarmLink[]
  producerStateRegistrations ProducerStateRegistration[]

  @@map("farms")
}

model FarmRegistration {
  id               String    @id @default(uuid())
  farmId           String
  number           String
  cnsCode          String?
  cartorioName     String
  comarca          String
  state            String    @db.VarChar(2)
  livro            String?
  registrationDate DateTime?
  areaHa           Decimal   @db.Decimal(12, 4)
  boundaryAreaHa   Decimal?  @db.Decimal(12, 4)
  boundary         Unsupported("geometry(Polygon, 4326)")?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  farm          Farm                      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  producerLinks ProducerRegistrationLink[]

  @@index([farmId])
  @@map("farm_registrations")
}

model FarmDocument {
  id        String   @id @default(uuid())
  farmId    String
  type      String
  filename  String
  url       String
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@map("farm_documents")
}

model UserFarmAccess {
  id     String @id @default(uuid())
  userId String
  farmId String

  user User @relation(fields: [userId], references: [id])
  farm Farm @relation(fields: [farmId], references: [id])

  @@unique([userId, farmId])
  @@map("user_farm_access")
}

model CustomRole {
  id             String   @id @default(uuid())
  name           String
  description    String?
  baseRole       UserRole
  organizationId String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  permissions  RolePermission[]
  users        User[]

  @@unique([name, organizationId])
  @@map("custom_roles")
}

model RolePermission {
  id           String @id @default(uuid())
  customRoleId String
  module       String
  action       String
  allowed      Boolean @default(true)

  customRole CustomRole @relation(fields: [customRoleId], references: [id], onDelete: Cascade)

  @@unique([customRoleId, module, action])
  @@map("role_permissions")
}

model AuditLog {
  id             String   @id @default(uuid())
  actorId        String
  actorEmail     String
  actorRole      UserRole
  action         String
  targetType     String?
  targetId       String?
  metadata       Json?
  ipAddress      String?
  farmId         String?
  organizationId String?
  createdAt      DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@index([farmId])
  @@index([organizationId])
  @@map("audit_logs")
}

// ─── Producer Models ────────────────────────────────────────────────

model Producer {
  id                  String         @id @default(uuid())
  organizationId      String
  type                ProducerType
  name                String
  tradeName           String?
  document            String?
  birthDate           DateTime?
  spouseCpf           String?
  incraRegistration   String?
  legalRepresentative String?
  legalRepCpf         String?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  taxRegime           TaxRegime?
  mainCnae            String?
  ruralActivityType   String?
  status              ProducerStatus @default(ACTIVE)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  organization       Organization              @relation(fields: [organizationId], references: [id])
  participants       SocietyParticipant[]
  stateRegistrations ProducerStateRegistration[]
  farmLinks          ProducerFarmLink[]
  documents          ProducerDocument[]

  @@unique([document, organizationId])
  @@index([organizationId])
  @@map("producers")
}

model SocietyParticipant {
  id               String   @id @default(uuid())
  producerId       String
  name             String
  cpf              String
  participationPct Decimal  @db.Decimal(5, 2)
  isMainResponsible Boolean @default(false)
  createdAt        DateTime @default(now())

  producer Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@unique([producerId, cpf])
  @@index([producerId])
  @@map("society_participants")
}

model ProducerStateRegistration {
  id               String       @id @default(uuid())
  producerId       String
  farmId           String?
  number           String
  state            String       @db.VarChar(2)
  cnaeActivity     String?
  assessmentRegime String?
  category         IeCategory?
  inscriptionDate  DateTime?
  situation        IeSituation  @default(ACTIVE)
  contractEndDate  DateTime?
  milkProgramOptIn Boolean      @default(false)
  isDefaultForFarm Boolean      @default(false)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  producer Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)
  farm     Farm?    @relation(fields: [farmId], references: [id], onDelete: SetNull)

  @@unique([producerId, number, state])
  @@index([producerId])
  @@index([farmId])
  @@map("producer_state_registrations")
}

model ProducerFarmLink {
  id               String              @id @default(uuid())
  producerId       String
  farmId           String
  bondType         ProducerFarmBondType
  participationPct Decimal?            @db.Decimal(5, 2)
  startDate        DateTime?
  endDate          DateTime?
  isItrDeclarant   Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  producer          Producer                  @relation(fields: [producerId], references: [id], onDelete: Cascade)
  farm              Farm                      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  registrationLinks ProducerRegistrationLink[]

  @@unique([producerId, farmId, bondType])
  @@index([producerId])
  @@index([farmId])
  @@index([endDate])
  @@map("producer_farm_links")
}

model ProducerRegistrationLink {
  id                 String   @id @default(uuid())
  farmLinkId         String
  farmRegistrationId String
  createdAt          DateTime @default(now())

  farmLink         ProducerFarmLink @relation(fields: [farmLinkId], references: [id], onDelete: Cascade)
  farmRegistration FarmRegistration  @relation(fields: [farmRegistrationId], references: [id], onDelete: Cascade)

  @@unique([farmLinkId, farmRegistrationId])
  @@index([farmLinkId])
  @@index([farmRegistrationId])
  @@map("producer_registration_links")
}

model ProducerDocument {
  id         String   @id @default(uuid())
  producerId String
  type       String
  filename   String
  url        String
  mimeType   String?
  sizeBytes  Int?
  createdAt  DateTime @default(now())

  producer Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@index([producerId])
  @@map("producer_documents")
}
